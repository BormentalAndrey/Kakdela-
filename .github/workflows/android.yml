name: Android CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Правильная команда — собрать все возможные debug-AAB
      - name: Build all possible Debug AABs
        run: ./gradlew bundleDebug bundleFreeDebug bundlePaidDebug bundleDevDebug bundleStagingDebug bundleProdDebug --stacktrace || true
        # || true — чтобы не падал, если какой-то flavor отсутствует

      # Если и этого мало — просто соберём всё, что заканчивается на Debug
      - name: Build absolutely all debug variants (fallback)
        run: ./gradlew $(./gradlew -q tasks --all | grep -i "bundle.*Debug" | awk '{print $1}' | tr '\n' ' ') || true

      # Покажем, что реально появилось
      - name: List generated files
        run: |
          echo "=== Looking for AAB/APK ==="
          find . -type f \( -name "*.aab" -o -name "*.apk" \) -ls

      # Загрузим всё, что найдётся
      - name: Upload Debug Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kakdela-messenger-debug
          path: |
            **/*.aab
            **/*.apk
          if-no-files-found: warn
          retention-days: 30
