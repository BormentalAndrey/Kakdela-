name: Android CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
      uses: actions/checkout@v4

      name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

      name: Grant permission for gradlew
      run: chmod +x ./gradlew

      # Самое важное — покажем, какие модули и задачи вообще есть
      name: List all Gradle modules and debug tasks
      run: |
        echo "All project modules:"
        ./gradlew -q projects
        echo ""
        echo "All tasks containing 'Debug' or 'Bundle':"
        ./gradlew -q tasks --all | grep -i -E "(debug|bundle|assemble)"

      # Попробуем собрать всё, что хоть как-то похоже на debug-версию
      name: Try build any debug variant
      run: |
        ./gradlew assembleDebug bundleDebug \
                   :app:assembleDebug :app:bundleDebug \
                   :mobile:assembleDebug :messenger:assembleDebug \
                   :kakdela:assembleDebug || echo "No standard debug tasks succeeded"

      # Покажем, что реально появилось после сборки
      name: Search for any AAB or APK in the whole project
      run: |
        echo "Searching in the entire workspace..."
        find . -type f \( -name "*.aab" -o -name "*.apk" \) -ls

      # Загрузим всё, что найдётся
      name: Upload artifact if anything was built
      uses: actions/upload-artifact@v4
      with:
        name: kakdela-any-debug-build
        path: |
          **/*.aab
          **/*.apk
        if-no-files-found: warn
        retention-days: 30
